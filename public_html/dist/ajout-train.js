import{d as $,r as m,l as G,N as U,O as F,c as _,o as y,a as f,w as j,m as T,P as H,F as P,b as Z,n as z,t as A,k as b,M as V}from"./chunks/runtime-dom.esm-bundler-Cpy2cnzk.js";import{_ as J}from"./chunks/FormAutocomplete.vue_vue_type_script_setup_true_lang-QbQ1WIl-.js";import"./chunks/Autocomplete.vue_vue_type_script_setup_true_lang-BM-vPuKD.js";const K={class:"relative w-full z-10"},X={class:"relative"},Q=["value","placeholder","disabled"],W={key:0,class:"absolute right-2 top-1/2 -translate-y-1/2"},Y={key:1,class:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 fill-current opacity-50",viewBox:"0 0 24 24"},q=["onClick"],ee={class:"flex-1 min-w-0"},te={class:"font-medium truncate"},ne={key:0,class:"text-xs opacity-70 truncate"},ae={key:0,class:"absolute w-full bg-white border border-base-300 mt-1 p-2 text-sm text-base-content/60 rounded-lg z-50 shadow-lg"},oe="https://api.transitous.org/api/v1/geocode",le="Vélogrimpe.fr (https://velogrimpe.fr) - v0.1 - contact@velogrimpe.fr",R=$({__name:"TransitousStationSearch",props:{modelValue:{},placeholder:{default:""},disabled:{type:Boolean,default:!1},debounceMs:{default:1e3}},emits:["update:modelValue","select"],setup(i,{emit:p}){function h(e){if(!e.areas)return"";const t=e.areas.find(s=>s.default);return(t==null?void 0:t.name)||""}const r=i,v=p,a=m(null),c=m(null),n=m(!1),o=m(!1),l=m(-1),g=m(r.modelValue),d=m([]);let u=null;G(()=>r.modelValue,e=>{g.value=e});async function w(e){if(!e||e.length<2){d.value=[];return}o.value=!0;try{const t=`${oe}?text=${encodeURIComponent(e)}&type=STOP`,s=await fetch(t,{headers:{"X-Client-Identification":le}});if(!s.ok)throw new Error(`HTTP error: ${s.status}`);const S=await s.json(),k=["HIGHSPEED_RAIL","LONG_DISTANCE","REGIONAL_FAST_RAIL","REGIONAL_RAIL","SUBURBAN"];d.value=S.filter(C=>{var x;return!(C.type!=="STOP"||C.country!=="FR"||!((x=C.modes)!=null&&x.some(O=>k.includes(O))))}).slice(0,10)}catch(t){console.error("[TransitousStationSearch] Error fetching stations:",t),d.value=[]}finally{o.value=!1}}function E(e){u&&clearTimeout(u),u=setTimeout(()=>{w(e)},r.debounceMs)}function M(e){const t=e.target;g.value=t.value,v("update:modelValue",t.value),v("select",null),n.value=!0,l.value=-1,E(t.value)}function I(e){g.value=e.name,v("update:modelValue",e.name),v("select",e),n.value=!1,l.value=-1,d.value=[]}function N(e){const t=d.value;e.key==="ArrowDown"?(e.preventDefault(),t.length>0&&(l.value=(l.value+1)%t.length,L())):e.key==="ArrowUp"?(e.preventDefault(),t.length>0&&(l.value=l.value<=0?t.length-1:l.value-1,L())):e.key==="Enter"?(e.preventDefault(),l.value>=0&&l.value<t.length&&I(t[l.value])):e.key==="Escape"&&(e.preventDefault(),n.value=!1,l.value=-1)}function L(){if(l.value<0||!c.value)return;const e=c.value.querySelectorAll("li");e[l.value]&&e[l.value].scrollIntoView({behavior:"smooth",block:"nearest"})}function D(){setTimeout(()=>{n.value=!1},200)}function B(e){const t=e.target;a.value&&!a.value.contains(t)&&c.value&&!c.value.contains(t)&&(n.value=!1)}return U(()=>{document.addEventListener("click",B)}),F(()=>{document.removeEventListener("click",B),u&&clearTimeout(u)}),(e,t)=>(y(),_("div",K,[f("div",X,[f("input",{ref_key:"inputRef",ref:a,type:"search",value:g.value,placeholder:i.placeholder,disabled:i.disabled,class:"input input-sm w-full pr-8",autocomplete:"off",onInput:M,onKeydown:N,onFocus:t[0]||(t[0]=s=>n.value=!0),onBlur:D},null,40,Q),o.value?(y(),_("span",W,[...t[1]||(t[1]=[f("span",{class:"loading loading-spinner loading-xs"},null,-1)])])):(y(),_("svg",Y,[...t[2]||(t[2]=[f("path",{d:"M18.031 16.6168L22.3137 20.8995L20.8995 22.3137L16.6168 18.031C15.0769 19.263 13.124 20 11 20C6.032 20 2 15.968 2 11C2 6.032 6.032 2 11 2C15.968 2 20 6.032 20 11C20 13.124 19.263 15.0769 18.031 16.6168ZM16.0247 15.8748C17.2475 14.6146 18 12.8956 18 11C18 7.1325 14.8675 4 11 4C7.1325 4 4 7.1325 4 11C4 14.8675 7.1325 18 11 18C12.8956 18 14.6146 17.2475 15.8748 16.0247L16.0247 15.8748Z"},null,-1)])]))]),j(f("ul",{ref_key:"listRef",ref:c,class:"absolute w-full bg-white border border-primary mt-1 max-h-48 overflow-y-auto z-50 rounded-lg shadow-lg"},[(y(!0),_(P,null,Z(d.value,(s,S)=>(y(),_("li",{key:s.id||`${s.lat}-${s.lon}`,class:z(["p-2 cursor-pointer hover:bg-primary hover:text-white text-sm flex items-start gap-2",{"bg-primary text-white":S===l.value}]),onClick:k=>I(s)},[t[3]||(t[3]=f("svg",{class:"w-4 h-4 mt-0.5 shrink-0 opacity-60",viewBox:"0 0 24 24",fill:"currentColor"},[f("path",{d:"M17.2 20L19 22H5L6.8 20H17.2ZM12 2C16.42 2 20 3.79 20 6V15C20 16.66 18.66 18 17 18H7C5.34 18 4 16.66 4 15V6C4 3.79 7.58 2 12 2ZM12 12C9.79 12 8 12.9 8 14C8 15.1 9.79 16 12 16C14.21 16 16 15.1 16 14C16 12.9 14.21 12 12 12ZM18 6C18 5.11 15.31 4 12 4C8.69 4 6 5.11 6 6V10H18V6Z"})],-1)),f("div",ee,[f("div",te,A(s.name),1),h(s)?(y(),_("div",ne,A(h(s)),1)):T("",!0)])],10,q))),128))],512),[[H,n.value&&d.value.length>0]]),n.value&&!o.value&&g.value.length>=2&&d.value.length===0?(y(),_("div",ae," Aucune gare trouvée ")):T("",!0)]))}});document.addEventListener("DOMContentLoaded",()=>{se(),re()});function se(){const i=document.getElementById("vue-ajout-train");if(!i){console.warn("[velogrimpe] #vue-ajout-train mount point not found");return}let p=[],h=null;try{p=JSON.parse(i.dataset.gares||"[]"),h=i.dataset.presetGareNom||null}catch(a){console.error("[velogrimpe] Failed to parse ajout-train data:",a)}const r=()=>{const a=document.getElementById("gare_id"),c=document.getElementById("ville_id"),n=document.getElementById("train_tgv"),o=document.getElementById("submitBtn"),l=(a==null?void 0:a.value)||"",g=(c==null?void 0:c.value)||"",d=(n==null?void 0:n.checked)??!1;if(!l||!g){const u=document.getElementById("itineraireExistsAlert");u&&u.classList.add("hidden");return}fetch(`/api/verify_train_dup.php?gare_id=${l}&ville_id=${g}&train_tgv=${d?1:0}`).then(u=>u.json()).then(u=>{const w=document.getElementById("itineraireExistsAlert"),E=document.getElementById("itineraireExistsType");u?(w&&w.classList.remove("hidden"),E&&(E.textContent=d?"TGV":"TER"),o&&(o.disabled=!0)):(w&&w.classList.add("hidden"),o&&(o.disabled=!1))})};b({setup(){const a=m(h||""),c=n=>{const o=document.getElementById("gare_id");n?(o&&(o.value=String(n.id)),r()):o&&(o.value="")};return setTimeout(()=>{const n=document.getElementById("ville_id"),o=document.getElementById("train_tgv");n==null||n.addEventListener("change",r),o==null||o.addEventListener("change",r)},0),()=>V(J,{modelValue:a.value,"onUpdate:modelValue":n=>{a.value=n},items:p,onSelect:c})}}).mount(i),console.log("[velogrimpe] Vue ajout-train gare autocomplete mounted")}function re(){const i=document.getElementById("vue-station-depart"),p=document.getElementById("vue-station-arrivee");!i&&!p||(window.__transitousStations__={depart:null,arrivee:null},i&&(b({setup(){const r=m(""),v=a=>{window.__transitousStations__&&(window.__transitousStations__.depart=a)};return()=>V(R,{modelValue:r.value,"onUpdate:modelValue":a=>{r.value=a},placeholder:"ex: Lyon Part-Dieu",onSelect:v})}}).mount(i),console.log("[velogrimpe] Vue station-depart search mounted")),p&&(b({setup(){const r=m(""),v=a=>{window.__transitousStations__&&(window.__transitousStations__.arrivee=a)};return()=>V(R,{modelValue:r.value,"onUpdate:modelValue":a=>{r.value=a},placeholder:"ex: Dijon Ville",onSelect:v})}}).mount(p),console.log("[velogrimpe] Vue station-arrivee search mounted")))}
