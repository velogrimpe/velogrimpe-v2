import{d as U,r as m,l as F,y as j,z as M,c as y,o as h,a as w,w as P,m as L,q as z,B as H,F as J,b as K,n as X,i as q,t as R,k,x as E}from"./chunks/runtime-dom.esm-bundler-CFjh9Irh.js";import{_ as Q}from"./chunks/FormAutocomplete.vue_vue_type_script_setup_true_lang-BdKR2Brq.js";import{_ as N}from"./chunks/Icon.vue_vue_type_script_setup_true_lang-CxRcsHEs.js";import"./chunks/Autocomplete.vue_vue_type_script_setup_true_lang-DITvEN9E.js";const W={class:"relative w-full z-10"},Y={class:"relative"},Z=["value","placeholder","disabled"],ee={key:0,class:"absolute right-2 top-1/2 -translate-y-1/2"},te=["onClick"],ne={class:"flex-1 min-w-0"},ae={class:"font-medium truncate"},oe={key:0,class:"text-xs opacity-70 truncate"},le={key:0,class:"absolute w-full bg-white border border-base-300 mt-1 p-2 text-sm text-base-content/60 rounded-lg z-50 shadow-lg"},se="https://api.transitous.org/api/v1/geocode",re="Vélogrimpe.fr (https://velogrimpe.fr) - v0.1 - contact@velogrimpe.fr",D=U({__name:"TransitousStationSearch",props:{modelValue:{},placeholder:{default:""},disabled:{type:Boolean,default:!1},debounceMs:{default:1e3}},emits:["update:modelValue","select"],setup(i,{emit:f}){function g(e){if(!e.areas)return"";const t=e.areas.find(s=>s.default);return(t==null?void 0:t.name)||""}const r=i,v=f,o=m(null),c=m(null),a=m(!1),l=m(!1),n=m(-1),p=m(r.modelValue),d=m([]);let u=null;F(()=>r.modelValue,e=>{p.value=e});async function _(e){if(!e||e.length<2){d.value=[];return}l.value=!0;try{const t=`${se}?text=${encodeURIComponent(e)}&type=STOP`,s=await fetch(t,{headers:{"X-Client-Identification":re}});if(!s.ok)throw new Error(`HTTP error: ${s.status}`);const b=await s.json(),T=["HIGHSPEED_RAIL","LONG_DISTANCE","REGIONAL_FAST_RAIL","REGIONAL_RAIL","SUBURBAN"];d.value=b.filter(I=>{var A;return!(I.type!=="STOP"||I.country!=="FR"||!((A=I.modes)!=null&&A.some(O=>T.includes(O))))}).slice(0,10)}catch(t){console.error("[TransitousStationSearch] Error fetching stations:",t),d.value=[]}finally{l.value=!1}}function S(e){u&&clearTimeout(u),u=setTimeout(()=>{_(e)},r.debounceMs)}function $(e){const t=e.target;p.value=t.value,v("update:modelValue",t.value),v("select",null),a.value=!0,n.value=-1,S(t.value)}function B(e){p.value=e.name,v("update:modelValue",e.name),v("select",e),a.value=!1,n.value=-1,d.value=[]}function C(e){const t=d.value;e.key==="ArrowDown"?(e.preventDefault(),t.length>0&&(n.value=(n.value+1)%t.length,V())):e.key==="ArrowUp"?(e.preventDefault(),t.length>0&&(n.value=n.value<=0?t.length-1:n.value-1,V())):e.key==="Enter"?(e.preventDefault(),n.value>=0&&n.value<t.length&&B(t[n.value])):e.key==="Escape"&&(e.preventDefault(),a.value=!1,n.value=-1)}function V(){if(n.value<0||!c.value)return;const e=c.value.querySelectorAll("li");e[n.value]&&e[n.value].scrollIntoView({behavior:"smooth",block:"nearest"})}function G(){setTimeout(()=>{a.value=!1},200)}function x(e){const t=e.target;o.value&&!o.value.contains(t)&&c.value&&!c.value.contains(t)&&(a.value=!1)}return j(()=>{document.addEventListener("click",x)}),M(()=>{document.removeEventListener("click",x),u&&clearTimeout(u)}),(e,t)=>(h(),y("div",W,[w("div",Y,[w("input",{ref_key:"inputRef",ref:o,type:"search",value:p.value,placeholder:i.placeholder,disabled:i.disabled,class:"input input-sm w-full pr-8",autocomplete:"off",onInput:$,onKeydown:C,onFocus:t[0]||(t[0]=s=>a.value=!0),onBlur:G},null,40,Z),l.value?(h(),y("span",ee,[...t[1]||(t[1]=[w("span",{class:"loading loading-spinner loading-xs"},null,-1)])])):(h(),z(N,{key:1,name:"search",class:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 opacity-50"}))]),P(w("ul",{ref_key:"listRef",ref:c,class:"absolute w-full bg-white border border-primary mt-1 max-h-48 overflow-y-auto z-50 rounded-lg shadow-lg"},[(h(!0),y(J,null,K(d.value,(s,b)=>(h(),y("li",{key:s.id||`${s.lat}-${s.lon}`,class:X(["p-2 cursor-pointer hover:bg-primary hover:text-white text-sm flex items-start gap-2",{"bg-primary text-white":b===n.value}]),onClick:T=>B(s)},[q(N,{name:"train",class:"w-4 h-4 mt-0.5 shrink-0 opacity-60"}),w("div",ne,[w("div",ae,R(s.name),1),g(s)?(h(),y("div",oe,R(g(s)),1)):L("",!0)])],10,te))),128))],512),[[H,a.value&&d.value.length>0]]),a.value&&!l.value&&p.value.length>=2&&d.value.length===0?(h(),y("div",le," Aucune gare trouvée ")):L("",!0)]))}}),ie=()=>({icon:()=>E("svg",{class:"w-4 h-4 fill-none stroke-current shrink-0"},[E("use",{href:"#search"})])});document.addEventListener("DOMContentLoaded",()=>{ue(),ce()});function ue(){const i=document.getElementById("vue-ajout-train");if(!i){console.warn("[velogrimpe] #vue-ajout-train mount point not found");return}let f=[],g=null;try{f=JSON.parse(i.dataset.gares||"[]"),g=i.dataset.presetGareNom||null}catch(o){console.error("[velogrimpe] Failed to parse ajout-train data:",o)}const r=()=>{const o=document.getElementById("gare_id"),c=document.getElementById("ville_id"),a=document.getElementById("train_tgv"),l=document.getElementById("submitBtn"),n=(o==null?void 0:o.value)||"",p=(c==null?void 0:c.value)||"",d=(a==null?void 0:a.checked)??!1;if(!n||!p){const u=document.getElementById("itineraireExistsAlert");u&&u.classList.add("hidden");return}fetch(`/api/verify_train_dup.php?gare_id=${n}&ville_id=${p}&train_tgv=${d?1:0}`).then(u=>u.json()).then(u=>{const _=document.getElementById("itineraireExistsAlert"),S=document.getElementById("itineraireExistsType");u?(_&&_.classList.remove("hidden"),S&&(S.textContent=d?"TGV":"TER"),l&&(l.disabled=!0)):(_&&_.classList.add("hidden"),l&&(l.disabled=!1))})};k({setup(){const o=m(g||""),c=a=>{const l=document.getElementById("gare_id"),n=document.getElementById("train_arrivee");a?(l&&(l.value=String(a.id)),n&&(n.value=a.nom),r()):(l&&(l.value=""),n&&(n.value=""))};return setTimeout(()=>{const a=document.getElementById("ville_id"),l=document.getElementById("train_tgv");a==null||a.addEventListener("change",r),l==null||l.addEventListener("change",r)},0),()=>E(Q,{modelValue:o.value,"onUpdate:modelValue":a=>{o.value=a},items:f,onSelect:c},ie())}}).mount(i),console.log("[velogrimpe] Vue ajout-train gare autocomplete mounted")}function ce(){const i=document.getElementById("vue-station-depart"),f=document.getElementById("vue-station-arrivee");!i&&!f||(window.__transitousStations__={depart:null,arrivee:null},i&&(k({setup(){const r=m(""),v=o=>{window.__transitousStations__&&(window.__transitousStations__.depart=o)};return()=>E(D,{modelValue:r.value,"onUpdate:modelValue":o=>{r.value=o},placeholder:"ex: Lyon Part-Dieu",onSelect:v})}}).mount(i),console.log("[velogrimpe] Vue station-depart search mounted")),f&&(k({setup(){const r=m(""),v=o=>{window.__transitousStations__&&(window.__transitousStations__.arrivee=o)};return()=>E(D,{modelValue:r.value,"onUpdate:modelValue":o=>{r.value=o},placeholder:"ex: Dijon Ville",onSelect:v})}}).mount(f),console.log("[velogrimpe] Vue station-arrivee search mounted")))}
