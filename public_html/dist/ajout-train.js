import{d as U,r as m,l as F,N as M,O as j,c as y,o as h,a as w,w as P,m as A,s as z,P as H,F as J,b as K,n as X,i as Q,t as R,k as I,M as V}from"./chunks/runtime-dom.esm-bundler-Cpy2cnzk.js";import{_ as W}from"./chunks/FormAutocomplete.vue_vue_type_script_setup_true_lang-1__GtXz4.js";import{_ as N}from"./chunks/Icon.vue_vue_type_script_setup_true_lang-5czbgEqT.js";import"./chunks/Autocomplete.vue_vue_type_script_setup_true_lang-B97YQDHO.js";const Y={class:"relative w-full z-10"},Z={class:"relative"},q=["value","placeholder","disabled"],ee={key:0,class:"absolute right-2 top-1/2 -translate-y-1/2"},te=["onClick"],ae={class:"flex-1 min-w-0"},ne={class:"font-medium truncate"},oe={key:0,class:"text-xs opacity-70 truncate"},le={key:0,class:"absolute w-full bg-white border border-base-300 mt-1 p-2 text-sm text-base-content/60 rounded-lg z-50 shadow-lg"},se="https://api.transitous.org/api/v1/geocode",re="Vélogrimpe.fr (https://velogrimpe.fr) - v0.1 - contact@velogrimpe.fr",D=U({__name:"TransitousStationSearch",props:{modelValue:{},placeholder:{default:""},disabled:{type:Boolean,default:!1},debounceMs:{default:1e3}},emits:["update:modelValue","select"],setup(i,{emit:f}){function g(e){if(!e.areas)return"";const t=e.areas.find(s=>s.default);return(t==null?void 0:t.name)||""}const r=i,v=f,n=m(null),c=m(null),a=m(!1),o=m(!1),l=m(-1),p=m(r.modelValue),d=m([]);let u=null;F(()=>r.modelValue,e=>{p.value=e});async function _(e){if(!e||e.length<2){d.value=[];return}o.value=!0;try{const t=`${se}?text=${encodeURIComponent(e)}&type=STOP`,s=await fetch(t,{headers:{"X-Client-Identification":re}});if(!s.ok)throw new Error(`HTTP error: ${s.status}`);const S=await s.json(),x=["HIGHSPEED_RAIL","LONG_DISTANCE","REGIONAL_FAST_RAIL","REGIONAL_RAIL","SUBURBAN"];d.value=S.filter(b=>{var L;return!(b.type!=="STOP"||b.country!=="FR"||!((L=b.modes)!=null&&L.some(G=>x.includes(G))))}).slice(0,10)}catch(t){console.error("[TransitousStationSearch] Error fetching stations:",t),d.value=[]}finally{o.value=!1}}function E(e){u&&clearTimeout(u),u=setTimeout(()=>{_(e)},r.debounceMs)}function $(e){const t=e.target;p.value=t.value,v("update:modelValue",t.value),v("select",null),a.value=!0,l.value=-1,E(t.value)}function k(e){p.value=e.name,v("update:modelValue",e.name),v("select",e),a.value=!1,l.value=-1,d.value=[]}function C(e){const t=d.value;e.key==="ArrowDown"?(e.preventDefault(),t.length>0&&(l.value=(l.value+1)%t.length,B())):e.key==="ArrowUp"?(e.preventDefault(),t.length>0&&(l.value=l.value<=0?t.length-1:l.value-1,B())):e.key==="Enter"?(e.preventDefault(),l.value>=0&&l.value<t.length&&k(t[l.value])):e.key==="Escape"&&(e.preventDefault(),a.value=!1,l.value=-1)}function B(){if(l.value<0||!c.value)return;const e=c.value.querySelectorAll("li");e[l.value]&&e[l.value].scrollIntoView({behavior:"smooth",block:"nearest"})}function O(){setTimeout(()=>{a.value=!1},200)}function T(e){const t=e.target;n.value&&!n.value.contains(t)&&c.value&&!c.value.contains(t)&&(a.value=!1)}return M(()=>{document.addEventListener("click",T)}),j(()=>{document.removeEventListener("click",T),u&&clearTimeout(u)}),(e,t)=>(h(),y("div",Y,[w("div",Z,[w("input",{ref_key:"inputRef",ref:n,type:"search",value:p.value,placeholder:i.placeholder,disabled:i.disabled,class:"input input-sm w-full pr-8",autocomplete:"off",onInput:$,onKeydown:C,onFocus:t[0]||(t[0]=s=>a.value=!0),onBlur:O},null,40,q),o.value?(h(),y("span",ee,[...t[1]||(t[1]=[w("span",{class:"loading loading-spinner loading-xs"},null,-1)])])):(h(),z(N,{key:1,name:"search",class:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 opacity-50"}))]),P(w("ul",{ref_key:"listRef",ref:c,class:"absolute w-full bg-white border border-primary mt-1 max-h-48 overflow-y-auto z-50 rounded-lg shadow-lg"},[(h(!0),y(J,null,K(d.value,(s,S)=>(h(),y("li",{key:s.id||`${s.lat}-${s.lon}`,class:X(["p-2 cursor-pointer hover:bg-primary hover:text-white text-sm flex items-start gap-2",{"bg-primary text-white":S===l.value}]),onClick:x=>k(s)},[Q(N,{name:"train",class:"w-4 h-4 mt-0.5 shrink-0 opacity-60"}),w("div",ae,[w("div",ne,R(s.name),1),g(s)?(h(),y("div",oe,R(g(s)),1)):A("",!0)])],10,te))),128))],512),[[H,a.value&&d.value.length>0]]),a.value&&!o.value&&p.value.length>=2&&d.value.length===0?(h(),y("div",le," Aucune gare trouvée ")):A("",!0)]))}});document.addEventListener("DOMContentLoaded",()=>{ie(),ue()});function ie(){const i=document.getElementById("vue-ajout-train");if(!i){console.warn("[velogrimpe] #vue-ajout-train mount point not found");return}let f=[],g=null;try{f=JSON.parse(i.dataset.gares||"[]"),g=i.dataset.presetGareNom||null}catch(n){console.error("[velogrimpe] Failed to parse ajout-train data:",n)}const r=()=>{const n=document.getElementById("gare_id"),c=document.getElementById("ville_id"),a=document.getElementById("train_tgv"),o=document.getElementById("submitBtn"),l=(n==null?void 0:n.value)||"",p=(c==null?void 0:c.value)||"",d=(a==null?void 0:a.checked)??!1;if(!l||!p){const u=document.getElementById("itineraireExistsAlert");u&&u.classList.add("hidden");return}fetch(`/api/verify_train_dup.php?gare_id=${l}&ville_id=${p}&train_tgv=${d?1:0}`).then(u=>u.json()).then(u=>{const _=document.getElementById("itineraireExistsAlert"),E=document.getElementById("itineraireExistsType");u?(_&&_.classList.remove("hidden"),E&&(E.textContent=d?"TGV":"TER"),o&&(o.disabled=!0)):(_&&_.classList.add("hidden"),o&&(o.disabled=!1))})};I({setup(){const n=m(g||""),c=a=>{const o=document.getElementById("gare_id");a?(o&&(o.value=String(a.id)),r()):o&&(o.value="")};return setTimeout(()=>{const a=document.getElementById("ville_id"),o=document.getElementById("train_tgv");a==null||a.addEventListener("change",r),o==null||o.addEventListener("change",r)},0),()=>V(W,{modelValue:n.value,"onUpdate:modelValue":a=>{n.value=a},items:f,onSelect:c})}}).mount(i),console.log("[velogrimpe] Vue ajout-train gare autocomplete mounted")}function ue(){const i=document.getElementById("vue-station-depart"),f=document.getElementById("vue-station-arrivee");!i&&!f||(window.__transitousStations__={depart:null,arrivee:null},i&&(I({setup(){const r=m(""),v=n=>{window.__transitousStations__&&(window.__transitousStations__.depart=n)};return()=>V(D,{modelValue:r.value,"onUpdate:modelValue":n=>{r.value=n},placeholder:"ex: Lyon Part-Dieu",onSelect:v})}}).mount(i),console.log("[velogrimpe] Vue station-depart search mounted")),f&&(I({setup(){const r=m(""),v=n=>{window.__transitousStations__&&(window.__transitousStations__.arrivee=n)};return()=>V(D,{modelValue:r.value,"onUpdate:modelValue":n=>{r.value=n},placeholder:"ex: Dijon Ville",onSelect:v})}}).mount(f),console.log("[velogrimpe] Vue station-arrivee search mounted")))}
