import{d as $,r as c,l as C,N as D,O as N,c as _,o as y,a as w,w as O,m as R,P as U,F as j,b as M,n as F,t as G,k as S,M as V}from"./chunks/runtime-dom.esm-bundler-Cpy2cnzk.js";import{_ as P}from"./chunks/FormAutocomplete.vue_vue_type_script_setup_true_lang-QbQ1WIl-.js";import z from"/symbols/icons.svg";import"./chunks/Autocomplete.vue_vue_type_script_setup_true_lang-BM-vPuKD.js";const H=z+"#ri-search-line",J={class:"relative w-full"},K={class:"relative"},X=["value","placeholder","disabled"],Q={key:0,class:"absolute right-2 top-1/2 -translate-y-1/2"},W={key:1,class:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 fill-current opacity-50"},Y=["onClick"],Z={key:0,class:"absolute w-full bg-white border border-base-300 mt-1 p-2 text-sm text-base-content/60 rounded-lg"},q="https://api.transitous.org/api/v1/geocode",ee="Vélogrimpe.fr (https://velogrimpe.fr) - v0.1 - contact@velogrimpe.fr",x=$({__name:"TransitousStationSearch",props:{modelValue:{},placeholder:{default:""},disabled:{type:Boolean,default:!1},debounceMs:{default:1e3}},emits:["update:modelValue","select"],setup(i,{emit:d}){const m=i,l=d,v=c(null),a=c(null),s=c(!1),o=c(!1),e=c(-1),p=c(m.modelValue),r=c([]);let f=null;C(()=>m.modelValue,t=>{p.value=t});async function g(t){if(!t||t.length<2){r.value=[];return}o.value=!0;try{const n=`${q}?text=${encodeURIComponent(t)}&type=STOP`,u=await fetch(n,{headers:{"X-Client-Identification":ee}});if(!u.ok)throw new Error(`HTTP error: ${u.status}`);const E=await u.json();r.value=E.filter(T=>T.type==="STOP").slice(0,10)}catch(n){console.error("[TransitousStationSearch] Error fetching stations:",n),r.value=[]}finally{o.value=!1}}function h(t){f&&clearTimeout(f),f=setTimeout(()=>{g(t)},m.debounceMs)}function b(t){const n=t.target;p.value=n.value,l("update:modelValue",n.value),l("select",null),s.value=!0,e.value=-1,h(n.value)}function k(t){p.value=t.name,l("update:modelValue",t.name),l("select",t),s.value=!1,e.value=-1,r.value=[]}function L(t){const n=r.value;t.key==="ArrowDown"?(t.preventDefault(),n.length>0&&(e.value=(e.value+1)%n.length,B())):t.key==="ArrowUp"?(t.preventDefault(),n.length>0&&(e.value=e.value<=0?n.length-1:e.value-1,B())):t.key==="Enter"?(t.preventDefault(),e.value>=0&&e.value<n.length&&k(n[e.value])):t.key==="Escape"&&(t.preventDefault(),s.value=!1,e.value=-1)}function B(){if(e.value<0||!a.value)return;const t=a.value.querySelectorAll("li");t[e.value]&&t[e.value].scrollIntoView({behavior:"smooth",block:"nearest"})}function A(){setTimeout(()=>{s.value=!1},200)}function I(t){const n=t.target;v.value&&!v.value.contains(n)&&a.value&&!a.value.contains(n)&&(s.value=!1)}return D(()=>{document.addEventListener("click",I)}),N(()=>{document.removeEventListener("click",I),f&&clearTimeout(f)}),(t,n)=>(y(),_("div",J,[w("div",K,[w("input",{ref_key:"inputRef",ref:v,type:"search",value:p.value,placeholder:i.placeholder,disabled:i.disabled,class:"input input-sm w-full pr-8",autocomplete:"off",onInput:b,onKeydown:L,onFocus:n[0]||(n[0]=u=>s.value=!0),onBlur:A},null,40,X),o.value?(y(),_("span",Q,[...n[1]||(n[1]=[w("span",{class:"loading loading-spinner loading-xs"},null,-1)])])):(y(),_("svg",W,[...n[2]||(n[2]=[w("use",{"xlink:href":H},null,-1)])]))]),O(w("ul",{ref_key:"listRef",ref:a,class:"absolute w-full bg-white border border-primary mt-1 max-h-48 overflow-y-auto z-50 rounded-lg shadow-lg"},[(y(!0),_(j,null,M(r.value,(u,E)=>(y(),_("li",{key:u.id||`${u.lat}-${u.lon}`,class:F(["p-2 cursor-pointer hover:bg-primary hover:text-white text-sm",{"bg-primary text-white":E===e.value}]),onClick:T=>k(u)},G(u.name),11,Y))),128))],512),[[U,s.value&&r.value.length>0]]),s.value&&!o.value&&p.value.length>=2&&r.value.length===0?(y(),_("div",Z," Aucune gare trouvée ")):R("",!0)]))}});document.addEventListener("DOMContentLoaded",()=>{te(),ne()});function te(){const i=document.getElementById("vue-ajout-train");if(!i){console.warn("[velogrimpe] #vue-ajout-train mount point not found");return}let d=[],m=null;try{d=JSON.parse(i.dataset.gares||"[]"),m=i.dataset.presetGareNom||null}catch(a){console.error("[velogrimpe] Failed to parse ajout-train data:",a)}const l=()=>{const a=document.getElementById("gare_id"),s=document.getElementById("ville_id"),o=document.getElementById("train_tgv"),e=document.getElementById("submitBtn"),p=(a==null?void 0:a.value)||"",r=(s==null?void 0:s.value)||"",f=(o==null?void 0:o.checked)??!1;if(!p||!r){const g=document.getElementById("itineraireExistsAlert");g&&g.classList.add("hidden");return}fetch(`/api/verify_train_dup.php?gare_id=${p}&ville_id=${r}&train_tgv=${f?1:0}`).then(g=>g.json()).then(g=>{const h=document.getElementById("itineraireExistsAlert"),b=document.getElementById("itineraireExistsType");g?(h&&h.classList.remove("hidden"),b&&(b.textContent=f?"TGV":"TER"),e&&(e.disabled=!0)):(h&&h.classList.add("hidden"),e&&(e.disabled=!1))})};S({setup(){const a=c(m||""),s=o=>{const e=document.getElementById("gare_id");o?(e&&(e.value=String(o.id)),l()):e&&(e.value="")};return setTimeout(()=>{const o=document.getElementById("ville_id"),e=document.getElementById("train_tgv");o==null||o.addEventListener("change",l),e==null||e.addEventListener("change",l)},0),()=>V(P,{modelValue:a.value,"onUpdate:modelValue":o=>{a.value=o},items:d,onSelect:s})}}).mount(i),console.log("[velogrimpe] Vue ajout-train gare autocomplete mounted")}function ne(){const i=document.getElementById("vue-station-depart"),d=document.getElementById("vue-station-arrivee");!i&&!d||(window.__transitousStations__={depart:null,arrivee:null},i&&(S({setup(){const l=c(""),v=a=>{window.__transitousStations__&&(window.__transitousStations__.depart=a)};return()=>V(x,{modelValue:l.value,"onUpdate:modelValue":a=>{l.value=a},placeholder:"ex: Lyon Part-Dieu",onSelect:v})}}).mount(i),console.log("[velogrimpe] Vue station-depart search mounted")),d&&(S({setup(){const l=c(""),v=a=>{window.__transitousStations__&&(window.__transitousStations__.arrivee=a)};return()=>V(x,{modelValue:l.value,"onUpdate:modelValue":a=>{l.value=a},placeholder:"ex: Dijon Ville",onSelect:v})}}).mount(d),console.log("[velogrimpe] Vue station-arrivee search mounted")))}
