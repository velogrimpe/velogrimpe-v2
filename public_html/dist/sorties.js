import{r as S,f as F,d as V,c as r,o as a,a as n,u as m,F as k,b as L,t as h,n as I,m as E,i as b,s as z,T,B as G,k as J}from"./chunks/runtime-dom.esm-bundler-CHpZyyPM.js";import{d as Y,c as H}from"./chunks/pinia-BLSXoc2I.js";import{_ as A}from"./chunks/Icon.vue_vue_type_script_setup_true_lang-Dfo531fH.js";import{u as K,_ as U,a as W,b as q}from"./chunks/ToastContainer.vue_vue_type_script_setup_true_lang-D8Vmkcli.js";/* empty css                                                                            */import{_ as Q}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";import"./chunks/useToast-CB8sFzkz.js";const N=Y("sorties",()=>{const l=S([]),o=S([]),d=S(null),c=S([]),t=S(null),e=S(new Date().toISOString().slice(0,7)),i=S(!1),u=S(!1);function $(){return document.getElementById("sortie-drawer")}const g=F(()=>{let s=l.value;return t.value!==null&&(s=s.filter(f=>f.ville_id===t.value)),s}),w=F(()=>g.value.filter(s=>{var x;const f=s.date_debut.slice(0,7),v=(x=s.date_fin)==null?void 0:x.slice(0,7);return f===e.value||v===e.value||f<=e.value&&(!v||v>=e.value)})),y=F(()=>{if(t.value===null)return null;const s=o.value.find(f=>f.ville_id===t.value);return(s==null?void 0:s.ville_nom)||null});async function j(s){o.value=s,await M()}async function M(){i.value=!0;try{const s=new URLSearchParams;t.value!==null&&s.append("ville_id",t.value.toString()),s.append("mois",e.value);const v=await(await fetch(`/api/fetch_sorties.php?${s}`)).json();v.success?l.value=v.sorties:console.error("Failed to fetch sorties:",v.error)}catch(s){console.error("Error fetching sorties:",s)}finally{i.value=!1}}async function p(s){d.value=s;const f=$();f&&(f.checked=s!==null),s&&s.falaise_principale_id?await _(s.falaise_principale_id):c.value=[]}async function _(s){u.value=!0;try{const v=await(await fetch(`/api/fetch_sortie_velos.php?falaise_id=${s}`)).json();v.success?c.value=v.velos:(console.error("Failed to fetch velo routes:",v.error),c.value=[])}catch(f){console.error("Error fetching velo routes:",f),c.value=[]}finally{u.value=!1}}function D(){const s=$();s&&(s.checked=!1),d.value=null,c.value=[]}function C(s){t.value=s,M()}function B(s){const[f,v]=e.value.split("-").map(Number),x=new Date(f,v,1);s==="prev"?x.setMonth(x.getMonth()-1):x.setMonth(x.getMonth()+1),e.value=x.toISOString().slice(0,7),M()}function P(s){e.value=s,M()}return{sorties:l,villes:o,selectedSortie:d,selectedSortieVelos:c,filterVilleId:t,currentMonth:e,isLoading:i,isLoadingVelos:u,filteredSorties:g,sortiesForMonth:w,selectedVilleName:y,initialize:j,fetchSorties:M,selectSortie:p,closeDrawer:D,setFilterVille:C,navigateMonth:B,setCurrentMonth:P}}),X={class:"bg-base-100 rounded-lg p-4 shadow-lg"},Z={class:"flex flex-col md:flex-row gap-4 items-start md:items-center justify-between"},ee={class:"flex-1"},te=["value"],se=["value"],ne={class:"text-sm text-base-content/70"},oe={key:0},ie={key:1},ae={key:2},re=V({__name:"SortiesFilter",setup(l){const o=N();function d(c){const t=c.target,e=t.value===""?null:Number(t.value);o.setFilterVille(e)}return(c,t)=>(a(),r("div",X,[n("div",Z,[n("div",ee,[t[1]||(t[1]=n("label",{for:"ville-filter",class:"label"},[n("span",{class:"label-text font-semibold"},"Filtrer par ville de départ")],-1)),n("select",{id:"ville-filter",class:"select select-bordered w-full max-w-xs",value:m(o).filterVilleId??"",onChange:d},[t[0]||(t[0]=n("option",{value:""},"Toutes les villes",-1)),(a(!0),r(k,null,L(m(o).villes,e=>(a(),r("option",{key:e.ville_id,value:e.ville_id},h(e.ville_nom),9,se))),128))],40,te)]),n("div",ne,[m(o).filteredSorties.length===0?(a(),r("span",oe,"Aucune sortie trouvée")):m(o).filteredSorties.length===1?(a(),r("span",ie,"1 sortie disponible")):(a(),r("span",ae,h(m(o).filteredSorties.length)+" sorties disponibles",1))])])]))}}),le={class:"relative"},ce={class:"text-xs text-base-content/70 truncate"},de={key:0,class:"text-xs text-base-content/60 mt-1"},R=V({__name:"SortieCard",props:{sortie:{},compact:{type:Boolean}},setup(l){const o=l,d=N();function c(){d.selectSortie(o.sortie)}return(t,e)=>(a(),r("div",le,[n("button",{class:I(["text-left w-full rounded p-2 transition-colors hover:bg-base-200 cursor-pointer",{"opacity-60":l.sortie.is_past,"text-xs":l.compact,"bg-primary/10 hover:bg-primary/20":!l.sortie.is_past,"bg-base-200":l.sortie.is_past}]),onClick:c},[n("div",{class:I(["font-semibold truncate",{"text-xs":l.compact}])},h(l.sortie.falaise_principale_nom),3),n("div",ce,h(l.sortie.ville_depart),1),l.sortie.nb_interesses>0?(a(),r("div",de,h(l.sortie.nb_interesses)+" intéressé"+h(l.sortie.nb_interesses>1?"s":""),1)):E("",!0)],2)]))}}),ue={class:"bg-base-100 rounded-lg shadow-lg p-4"},pe={class:"flex items-center justify-between mb-4"},fe={class:"text-xl font-bold capitalize"},me={class:"grid grid-cols-7 gap-1 mb-2"},ve={class:"grid grid-cols-7 gap-1"},_e={key:0,class:"flex flex-col gap-1"},he={key:0,class:"text-center py-8 text-base-content/60"},ge=V({__name:"SortiesCalendar",setup(l){const o=N(),d=F(()=>{const[e,i]=o.currentMonth.split("-").map(Number);return new Date(e,i-1,1).toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}),c=F(()=>{const[e,i]=o.currentMonth.split("-").map(Number),u=new Date(e,i-1,1),g=new Date(e,i,0).getDate();let w=u.getDay()-1;w===-1&&(w=6);const y=[],j=new Date(e,i-1,0).getDate();for(let p=w-1;p>=0;p--){const _=j-p,D=i===1?12:i-1,C=i===1?e-1:e;y.push({date:_,dateString:`${C}-${String(D).padStart(2,"0")}-${String(_).padStart(2,"0")}`,isCurrentMonth:!1,sorties:[]})}for(let p=1;p<=g;p++){const _=`${e}-${String(i).padStart(2,"0")}-${String(p).padStart(2,"0")}`,D=o.sortiesForMonth.filter(C=>{const B=C.date_debut,P=C.date_fin||C.date_debut;return B===_||B<=_&&P>=_});y.push({date:p,dateString:_,isCurrentMonth:!0,sorties:D})}const M=42-y.length;for(let p=1;p<=M;p++){const _=i===12?1:i+1,D=i===12?e+1:e;y.push({date:p,dateString:`${D}-${String(_).padStart(2,"0")}-${String(p).padStart(2,"0")}`,isCurrentMonth:!1,sorties:[]})}return y}),t=e=>{const i=new Date().toISOString().slice(0,10);return e===i};return(e,i)=>(a(),r("div",ue,[n("div",pe,[n("button",{class:"btn btn-sm btn-circle btn-ghost",onClick:i[0]||(i[0]=u=>m(o).navigateMonth("prev")),"aria-label":"Mois précédent"},[b(A,{name:"chevron-left"})]),n("h2",fe,h(d.value),1),n("button",{class:"btn btn-sm btn-circle btn-ghost",onClick:i[1]||(i[1]=u=>m(o).navigateMonth("next")),"aria-label":"Mois suivant"},[b(A,{name:"chevron-right"})])]),n("div",me,[(a(),r(k,null,L(["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],u=>n("div",{key:u,class:"text-center font-semibold text-sm py-2"},h(u),1)),64))]),n("div",ve,[(a(!0),r(k,null,L(c.value,(u,$)=>(a(),r("div",{key:$,class:I(["min-h-24 p-2 rounded border",{"bg-base-200":!u.isCurrentMonth,"bg-base-100":u.isCurrentMonth,"border-primary border-2":t(u.dateString),"border-base-300":!t(u.dateString)}])},[n("div",{class:I(["text-sm font-semibold mb-1",{"text-base-content/40":!u.isCurrentMonth,"text-primary":t(u.dateString)}])},h(u.date),3),u.sorties.length>0?(a(),r("div",_e,[(a(!0),r(k,null,L(u.sorties,g=>(a(),z(R,{key:g.sortie_id,sortie:g,compact:""},null,8,["sortie"]))),128))])):E("",!0)],2))),128))]),m(o).sortiesForMonth.length===0?(a(),r("div",he,[...i[2]||(i[2]=[n("p",{class:"text-lg"},"Aucune sortie prévue ce mois-ci",-1),n("p",{class:"text-sm mt-2"},[n("a",{href:"/ajout/ajout_sortie.php",class:"link link-primary"},"Proposez la première !")],-1)])])):E("",!0)]))}}),be={class:"bg-base-100 rounded-lg shadow-lg p-4"},ye={key:0,class:"flex flex-col gap-6"},xe={class:"text-lg font-semibold capitalize sticky top-0 bg-base-100 py-2"},Se={class:"space-y-2"},ke={key:1,class:"text-center py-8 text-base-content/60"},$e=V({__name:"SortiesList",setup(l){const o=N(),d=F(()=>{const c=new Map;return o.sortiesForMonth.forEach(t=>{const e=t.date_debut;c.has(e)||c.set(e,[]),c.get(e).push(t)}),Array.from(c.entries()).sort(([t],[e])=>t.localeCompare(e)).map(([t,e])=>({date:t,dateFormatted:new Date(t).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),sorties:e}))});return(c,t)=>(a(),r("div",be,[d.value.length>0?(a(),r("div",ye,[(a(!0),r(k,null,L(d.value,e=>(a(),r("div",{key:e.date,class:"space-y-2"},[n("h3",xe,h(e.dateFormatted),1),n("div",Se,[(a(!0),r(k,null,L(e.sorties,i=>(a(),z(R,{key:i.sortie_id,sortie:i},null,8,["sortie"]))),128))])]))),128))])):(a(),r("div",ke,[...t[0]||(t[0]=[n("p",{class:"text-lg"},"Aucune sortie prévue ce mois-ci",-1),n("p",{class:"text-sm mt-2"},[n("a",{href:"/ajout/ajout_sortie.php",class:"link link-primary"},"Proposez la première !")],-1)])]))]))}}),we={class:"p-6 w-full md:w-[600px] bg-base-100 min-h-full overflow-y-auto relative"},Me={key:0,class:"mt-8 drawer-content-wrapper"},De=V({__name:"SortieDrawer",setup(l){const o=N(),d=F(()=>o.selectedSortie),{isParticipationModalOpen:c,dateDisplay:t,openParticipationModal:e,closeParticipationModal:i,copyLink:u,handleGroupLinkClick:$}=K(()=>d.value);async function g(){d.value&&(await $(),o.fetchSorties())}function w(){o.fetchSorties()}return(y,j)=>(a(),r(k,null,[(a(),z(T,{to:"#drawer-side-target"},[n("div",we,[d.value?(a(),r("div",Me,[b(U,{sortie:d.value,"date-display":m(t),"on-group-link-click":g,"on-participation-click":m(e),"on-copy-link":m(u),class:"drawer-sortie-details"},null,8,["sortie","date-display","on-participation-click","on-copy-link"])])):E("",!0)])])),b(W,{sortie:d.value,"is-open":m(c),onClose:m(i),onSubmitted:w},null,8,["sortie","is-open","onClose"])],64))}}),Ce=Q(De,[["__scopeId","data-v-5496c5ff"]]),Fe={class:"flex flex-col gap-6"},Le={key:0,class:"flex justify-center py-12"},Ve={key:1},Ne={class:"md:hidden"},je={class:"hidden md:block"},Be=V({__name:"SortiesApp",props:{villes:{}},setup(l){const o=l,d=N();return G(()=>{d.initialize(o.villes)}),(c,t)=>(a(),r(k,null,[n("div",Fe,[b(re),m(d).isLoading?(a(),r("div",Le,[...t[0]||(t[0]=[n("span",{class:"loading loading-spinner loading-lg"},null,-1)])])):(a(),r("div",Ve,[n("div",Ne,[b($e)]),n("div",je,[b(ge)])]))]),b(Ce),b(q)],64))}});function O(){const l=document.getElementById("vue-sorties");if(!l){console.warn("[velogrimpe] #vue-sorties mount point not found");return}const o=l.dataset.villes;if(!o){console.error("[velogrimpe] villes data not found");return}const d=JSON.parse(o),c=J(Be,{villes:d}),t=H();c.use(t),c.mount(l),console.log("[velogrimpe] Vue sorties app mounted")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O();
