import{d as A,r as b,l as G,c as r,o as u,m as c,a as l,e as g,t as d,n as V,f as T,w,g as D,i as k,C as H,j as U,F as I,b as j,v as Q,u as E,k as X}from"./chunks/runtime-dom.esm-bundler-CFjh9Irh.js";import{c as Y}from"./chunks/pinia-CsLZD9ME.js";import"./chunks/useToast-C5d6NyTe.js";/* empty css                                                                            */import{_ as M}from"./chunks/FormAutocomplete.vue_vue_type_script_setup_true_lang-BdKR2Brq.js";import"./chunks/Autocomplete.vue_vue_type_script_setup_true_lang-DITvEN9E.js";const Z={class:"form-control w-full"},ee={key:0,class:"label"},ae={class:"label-text"},le={key:0,class:"text-error"},te=["value","placeholder","required","min","max"],ie={key:1,class:"label"},oe={class:"label-text-alt text-error"},N=A({__name:"DatePicker",props:{modelValue:{},label:{default:""},placeholder:{default:"Sélectionner une date"},required:{type:Boolean,default:!1},minDate:{default:""},maxDate:{default:""},error:{default:""}},emits:["update:modelValue"],setup(n,{emit:o}){const e=n,m=o,f=b(e.modelValue);G(()=>e.modelValue,v=>{f.value=v});function s(v){const p=v.target;f.value=p.value,m("update:modelValue",p.value)}return(v,p)=>(u(),r("div",Z,[n.label?(u(),r("label",ee,[l("span",ae,[g(d(n.label)+" ",1),n.required?(u(),r("span",le,"*")):c("",!0)])])):c("",!0),l("input",{type:"date",class:V(["input input-bordered w-full",{"input-error":n.error}]),value:f.value,placeholder:n.placeholder,required:n.required,min:n.minDate,max:n.maxDate,onInput:s},null,42,te),n.error?(u(),r("label",ie,[l("span",oe,d(n.error),1)])):c("",!0)]))}}),se={class:"card-body gap-6"},ne={class:"form-control w-full mb-4"},re={key:0,class:"label"},ue={class:"label-text-alt text-error"},de={class:"form-control w-full"},pe={key:0,class:"label"},ve={class:"label-text-alt text-error"},ce={class:"form-control w-full mb-4"},me={key:0,class:"label"},_e={class:"label-text-alt text-error"},fe={class:"form-control w-full mb-4"},be={key:0,class:"label"},ge={class:"label-text-alt text-error"},he={class:"form-control w-full mb-4"},xe={class:"flex gap-2"},we={key:0,class:"mt-2 flex flex-wrap gap-2"},ye=["onClick"],De={key:0,class:"text-sm text-base-content/60 mb-4"},ke={key:1,class:"form-control w-full mb-4"},Ve=["value"],Se={key:0,class:"mt-2"},$e={key:1,class:"label"},qe={class:"label-text-alt"},Me={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ce={class:"form-control w-full mb-4"},Fe={key:0,class:"label"},Te={class:"label-text-alt text-error"},Ue={class:"form-control w-full"},Ie={key:0,class:"label"},je={class:"label-text-alt text-error"},Ee={class:"card-actions justify-between mt-4"},Ne=["disabled"],Oe={key:1},Ae=["disabled"],Le={key:0,class:"loading loading-spinner"},Pe={key:1},Be=A({__name:"SortieForm",props:{villes:{},falaises:{},gares:{},editMode:{type:Boolean,default:!1},initialData:{default:void 0},editToken:{default:""}},setup(n){const o=n,e=b({organisateur_nom:"",organisateur_email:"",ville_depart:"",ville_id:null,falaise_principale_nom:"",falaise_principale_id:null,falaises_alternatives:[],velo_nom:"",velo_id:null,lien_groupe:"",description:"",date_debut:"",date_fin:""}),m=b(""),f=b(null),s=b({}),v=b(!1),p=b([]),h=b(!1);o.editMode&&o.initialData&&(e.value={sortie_id:o.initialData.sortie_id,organisateur_nom:o.initialData.organisateur_nom,organisateur_email:o.initialData.organisateur_email,ville_depart:o.initialData.ville_depart,ville_id:o.initialData.ville_id,falaise_principale_nom:o.initialData.falaise_principale_nom,falaise_principale_id:o.initialData.falaise_principale_id,falaises_alternatives:o.initialData.falaises_alternatives||[],velo_nom:o.initialData.velo_nom||"",velo_id:o.initialData.velo_id,lien_groupe:o.initialData.lien_groupe,description:o.initialData.description,date_debut:o.initialData.date_debut,date_fin:o.initialData.date_fin||""},o.initialData.falaise_principale_id&&C(o.initialData.falaise_principale_id));const $=T(()=>o.villes.map(i=>({id:i.ville_id,nom:i.ville_nom}))),S=T(()=>o.falaises.map(i=>({id:i.falaise_id,nom:i.falaise_nom})));if(!o.editMode&&typeof window<"u"&&window.contribStorage){const i=window.contribStorage.getContribInfo();i.nom&&(e.value.organisateur_nom=i.nom),i.email&&(e.value.organisateur_email=i.email)}const y=new Date().toISOString().split("T")[0];function q(i,a){e.value.ville_depart=a,e.value.ville_id=i?i.id:null}async function L(i,a){e.value.falaise_principale_nom=a,e.value.falaise_principale_id=i?i.id:null,i&&i.id?await C(i.id):(p.value=[],e.value.velo_nom="",e.value.velo_id=null)}async function C(i){h.value=!0;try{const t=await(await fetch(`/api/fetch_sortie_velos.php?falaise_id=${i}`)).json();t.success?p.value=t.velos:(console.error("Failed to fetch velo routes:",t.error),p.value=[])}catch(a){console.error("Error fetching velo routes:",a),p.value=[]}finally{h.value=!1}}function P(i){const t=i.target.value;if(t==="autre")e.value.velo_id="autre",e.value.velo_nom="";else if(t==="")e.value.velo_id=null,e.value.velo_nom="";else{const x=parseInt(t),_=p.value.find(W=>W.velo_id===x);_&&(e.value.velo_id=x,e.value.velo_nom=`${_.velo_depart} → ${_.velo_arrivee} (${_.velo_km} km, D+ ${_.velo_dplus}m)`)}}function B(i,a){m.value=a,f.value=i?i.id:null}function F(){m.value.trim()&&(e.value.falaises_alternatives.push({nom:m.value.trim(),id:f.value||void 0}),m.value="",f.value=null)}function J(i){e.value.falaises_alternatives.splice(i,1)}function z(){return s.value={},e.value.organisateur_nom.trim()||(s.value.organisateur_nom="Votre nom est requis"),e.value.organisateur_email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.value.organisateur_email)||(s.value.organisateur_email="Email invalide"):s.value.organisateur_email="Votre email est requis",e.value.ville_depart.trim()||(s.value.ville_depart="Ville de départ requise"),e.value.falaise_principale_nom.trim()||(s.value.falaise_principale_nom="Falaise principale requise"),e.value.lien_groupe.trim()&&!/^https?:\/\/.+/.test(e.value.lien_groupe)&&(s.value.lien_groupe="Le lien doit commencer par http:// ou https://"),e.value.description.trim()||(s.value.description="Description requise"),e.value.date_debut||(s.value.date_debut="Date de début requise"),e.value.date_fin&&e.value.date_debut&&e.value.date_fin<e.value.date_debut&&(s.value.date_fin="La date de fin doit être après la date de début"),Object.keys(s.value).length===0}async function R(){var i;if(z()){v.value=!0;try{!o.editMode&&typeof window<"u"&&window.contribStorage&&window.contribStorage.saveContribInfo(e.value.organisateur_nom,e.value.organisateur_email);const a=new FormData;o.editMode&&o.editToken&&(a.append("sortie_id",((i=e.value.sortie_id)==null?void 0:i.toString())||""),a.append("edit_token",o.editToken)),a.append("organisateur_nom",e.value.organisateur_nom),a.append("organisateur_email",e.value.organisateur_email),a.append("ville_depart",e.value.ville_depart),e.value.ville_id&&a.append("ville_id",e.value.ville_id.toString()),a.append("falaise_principale_nom",e.value.falaise_principale_nom),e.value.falaise_principale_id&&a.append("falaise_principale_id",e.value.falaise_principale_id.toString()),a.append("falaises_alternatives",JSON.stringify(e.value.falaises_alternatives)),e.value.velo_nom&&a.append("velo_nom",e.value.velo_nom),e.value.velo_id&&e.value.velo_id!=="autre"&&a.append("velo_id",e.value.velo_id.toString()),a.append("lien_groupe",e.value.lien_groupe),a.append("description",e.value.description),a.append("date_debut",e.value.date_debut),e.value.date_fin&&a.append("date_fin",e.value.date_fin);const t=o.editMode?"/api/private/edit_sortie.php":"/api/add_sortie.php",_=await(await fetch(t,{method:"POST",body:a})).json();_.success?o.editMode?(alert("Sortie modifiée avec succès !"),window.location.href="/sorties.php"):window.location.href=`/ajout/confirmation_sortie.php?sortie_id=${_.sortie_id}&token=${_.edit_token}`:alert(`Erreur : ${_.error}`)}catch(a){console.error("Error submitting form:",a),alert("Une erreur est survenue lors de l'envoi du formulaire")}finally{v.value=!1}}}async function K(){if(!(!o.editMode||!o.editToken||!e.value.sortie_id)&&confirm("Êtes-vous sûr de vouloir supprimer cette sortie ? Cette action est irréversible.")){v.value=!0;try{const i=new FormData;i.append("sortie_id",e.value.sortie_id.toString()),i.append("edit_token",o.editToken);const t=await(await fetch("/api/private/delete_sortie_organizer.php",{method:"POST",body:i})).json();t.success?(alert("Sortie supprimée avec succès"),window.location.href="/sorties.php"):alert(`Erreur : ${t.error}`)}catch(i){console.error("Error deleting sortie:",i),alert("Une erreur est survenue lors de la suppression")}finally{v.value=!1}}}return(i,a)=>(u(),r("form",{onSubmit:U(R,["prevent"]),class:"card bg-base-100 shadow-lg"},[l("div",se,[l("div",null,[a[14]||(a[14]=l("h2",{class:"text-xl font-bold mb-4"},"Vos informations",-1)),l("div",ne,[a[11]||(a[11]=l("label",{class:"label"},[l("span",{class:"label-text"},[g("Votre nom "),l("span",{class:"text-error"},"*")])],-1)),w(l("input",{"onUpdate:modelValue":a[0]||(a[0]=t=>e.value.organisateur_nom=t),type:"text",placeholder:"Prénom Nom",class:V(["input input-bordered w-full",{"input-error":s.value.organisateur_nom}]),required:""},null,2),[[D,e.value.organisateur_nom]]),s.value.organisateur_nom?(u(),r("label",re,[l("span",ue,d(s.value.organisateur_nom),1)])):c("",!0)]),l("div",de,[a[12]||(a[12]=l("label",{class:"label"},[l("span",{class:"label-text"},[g("Votre email "),l("span",{class:"text-error"},"*")])],-1)),w(l("input",{"onUpdate:modelValue":a[1]||(a[1]=t=>e.value.organisateur_email=t),type:"email",placeholder:"email@example.com",class:V(["input input-bordered w-full",{"input-error":s.value.organisateur_email}]),required:""},null,2),[[D,e.value.organisateur_email]]),s.value.organisateur_email?(u(),r("label",pe,[l("span",ve,d(s.value.organisateur_email),1)])):c("",!0),a[13]||(a[13]=l("label",{class:"label"},[l("span",{class:"label-text-alt"}," Cet email ne sera pas visible publiquement ")],-1))])]),l("div",null,[a[21]||(a[21]=l("h2",{class:"text-xl font-bold mb-4"},"Détails de la sortie",-1)),l("div",ce,[a[15]||(a[15]=l("label",{class:"label"},[l("span",{class:"label-text"},[g("Ville de départ "),l("span",{class:"text-error"},"*")])],-1)),k(M,{modelValue:e.value.ville_depart,"onUpdate:modelValue":a[2]||(a[2]=t=>e.value.ville_depart=t),items:$.value,placeholder:"Rechercher une ville...","accept-new-value":"",required:"",onSelect:q},null,8,["modelValue","items"]),s.value.ville_depart?(u(),r("label",me,[l("span",_e,d(s.value.ville_depart),1)])):c("",!0)]),l("div",fe,[a[16]||(a[16]=l("label",{class:"label"},[l("span",{class:"label-text"},[g("Falaise principale "),l("span",{class:"text-error"},"*")])],-1)),k(M,{modelValue:e.value.falaise_principale_nom,"onUpdate:modelValue":a[3]||(a[3]=t=>e.value.falaise_principale_nom=t),items:S.value,placeholder:"Rechercher une falaise...","accept-new-value":"",required:"",onSelect:L},null,8,["modelValue","items"]),s.value.falaise_principale_nom?(u(),r("label",be,[l("span",ge,d(s.value.falaise_principale_nom),1)])):c("",!0)]),l("div",he,[a[17]||(a[17]=l("label",{class:"label"},[l("span",{class:"label-text"},"Falaises alternatives (optionnel)")],-1)),l("div",xe,[k(M,{modelValue:m.value,"onUpdate:modelValue":a[4]||(a[4]=t=>m.value=t),items:S.value,placeholder:"Ajouter une falaise alternative","accept-new-value":"",class:"flex-1",onSelect:B,onKeydown:H(U(F,["prevent"]),["enter"])},null,8,["modelValue","items","onKeydown"]),l("button",{type:"button",class:"btn btn-outline",onClick:F}," Ajouter ")]),e.value.falaises_alternatives.length>0?(u(),r("div",we,[(u(!0),r(I,null,j(e.value.falaises_alternatives,(t,x)=>(u(),r("span",{key:x,class:"badge badge-lg gap-2"},[g(d(t.nom)+" ",1),l("button",{type:"button",class:"btn btn-ghost btn-xs btn-circle",onClick:_=>J(x)}," ✕ ",8,ye)]))),128))])):c("",!0)]),h.value?(u(),r("div",De," Chargement des itinéraires vélo... ")):c("",!0),!h.value&&e.value.falaise_principale_nom?(u(),r("div",ke,[a[20]||(a[20]=l("label",{class:"label"},[l("span",{class:"label-text"},"Itinéraire vélo prévu (optionnel)")],-1)),w(l("select",{"onUpdate:modelValue":a[5]||(a[5]=t=>e.value.velo_id=t),class:"select select-bordered w-full",onChange:P},[a[18]||(a[18]=l("option",{value:null,selected:""},"Aucun itinéraire sélectionné",-1)),(u(!0),r(I,null,j(p.value,t=>(u(),r("option",{key:t.velo_id,value:t.velo_id},d(t.velo_depart)+" → "+d(t.velo_arrivee)+" ("+d(t.velo_km)+" km, D+ "+d(t.velo_dplus)+"m) ",9,Ve))),128)),a[19]||(a[19]=l("option",{value:"autre"},"Autre (préciser ci-dessous)",-1))],544),[[Q,e.value.velo_id]]),e.value.velo_id==="autre"?(u(),r("div",Se,[w(l("input",{"onUpdate:modelValue":a[6]||(a[6]=t=>e.value.velo_nom=t),type:"text",placeholder:"Précisez votre itinéraire vélo...",class:"input input-bordered w-full"},null,512),[[D,e.value.velo_nom]])])):c("",!0),p.value.length>0?(u(),r("label",$e,[l("span",qe,d(p.value.length)+" itinéraire"+d(p.value.length>1?"s":"")+" disponible"+d(p.value.length>1?"s":"")+" pour cette falaise ",1)])):c("",!0)])):c("",!0)]),l("div",null,[a[22]||(a[22]=l("h2",{class:"text-xl font-bold mb-4"},"Dates",-1)),l("div",Me,[k(N,{modelValue:e.value.date_debut,"onUpdate:modelValue":a[7]||(a[7]=t=>e.value.date_debut=t),label:"Date de début","min-date":E(y),required:"",error:s.value.date_debut},null,8,["modelValue","min-date","error"]),k(N,{modelValue:e.value.date_fin,"onUpdate:modelValue":a[8]||(a[8]=t=>e.value.date_fin=t),label:"Date de fin (si plusieurs jours)","min-date":e.value.date_debut||E(y),error:s.value.date_fin},null,8,["modelValue","min-date","error"])])]),l("div",null,[a[26]||(a[26]=l("h2",{class:"text-xl font-bold mb-4"},"Informations complémentaires",-1)),l("div",Ce,[a[23]||(a[23]=l("label",{class:"label"},[l("span",{class:"label-text"}," Lien du groupe (Signal, WhatsApp, etc.) (optionnel) ")],-1)),w(l("input",{"onUpdate:modelValue":a[9]||(a[9]=t=>e.value.lien_groupe=t),type:"url",placeholder:"https://signal.group/...",class:V(["input input-bordered w-full",{"input-error":s.value.lien_groupe}])},null,2),[[D,e.value.lien_groupe]]),s.value.lien_groupe?(u(),r("label",Fe,[l("span",Te,d(s.value.lien_groupe),1)])):c("",!0),a[24]||(a[24]=l("label",{class:"label"},[l("span",{class:"label-text-alt"}," Les personnes intéressées pourront rejoindre ce groupe ")],-1))]),l("div",Ue,[a[25]||(a[25]=l("label",{class:"label"},[l("span",{class:"label-text"},[g("Description "),l("span",{class:"text-error"},"*")])],-1)),w(l("textarea",{"onUpdate:modelValue":a[10]||(a[10]=t=>e.value.description=t),class:V(["textarea textarea-bordered h-32",{"textarea-error":s.value.description}]),placeholder:"Décrivez votre sortie : objectifs, niveau attendu, matériel nécessaire...",required:""},null,2),[[D,e.value.description]]),s.value.description?(u(),r("label",Ie,[l("span",je,d(s.value.description),1)])):c("",!0)])]),l("div",Ee,[n.editMode?(u(),r("button",{key:0,type:"button",class:"btn btn-error btn-outline",disabled:v.value,onClick:K}," Supprimer la sortie ",8,Ne)):(u(),r("div",Oe)),l("button",{type:"submit",class:"btn btn-primary",disabled:v.value},[v.value?(u(),r("span",Le)):(u(),r("span",Pe,d(n.editMode?"Enregistrer les modifications":"Publier la sortie"),1))],8,Ae)])])],32))}});function O(){const n=document.getElementById("vue-sortie-form");if(!n){console.warn("[velogrimpe] #vue-sortie-form mount point not found");return}const o=n.dataset.villes,e=n.dataset.falaises,m=n.dataset.gares,f=n.dataset.sortie,s=n.dataset.editMode==="true",v=n.dataset.editToken||"";if(!o||!e||!m){console.error("[velogrimpe] Missing required data attributes");return}const p=JSON.parse(o),h=JSON.parse(e),$=JSON.parse(m),S=f?JSON.parse(f):void 0,y=X(Be,{villes:p,falaises:h,gares:$,editMode:s,initialData:S,editToken:v}),q=Y();y.use(q),y.mount(n),console.log("[velogrimpe] Vue sortie form mounted",s?"(edit mode)":"")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O();
